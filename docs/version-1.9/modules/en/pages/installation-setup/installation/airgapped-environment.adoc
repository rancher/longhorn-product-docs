= Install {longhorn-product-name} in an Air-Gapped Environment
:current-version: {page-component-version}
:doctype: book

{longhorn-product-name} can be installed in an air-gapped environment by using a Helm chart.

== Prerequisites

* https://helm.sh/docs/[Helm] v3.0 or later is required.
* Deploy {longhorn-product-name} components images to your own registry.
* Deploy Kubernetes CSI driver components images to your own registry.

== Image Management for Air-Gapped Environments

. **Obtain the list of required images** +
Run the link:{attachmentsdir}/download-longhorn-image-list.sh[script] to download the complete list of all images required for {longhorn-product-name}. The script will generate a `longhorn-images.txt` file containing the list of images.
+
[NOTE]
====
<<<<<<< HEAD

* A full list of all needed images is in https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/deploy/longhorn-images.txt[longhorn-images.txt]. First, download the images list by running:
+
[subs="+attributes",shell]
----
wget https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/deploy/longhorn-images.txt
----

* We provide a script, https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/save-images.sh[save-images.sh], to quickly pull the above `longhorn-images.txt` list. If you specify a `tar.gz` file name for flag `--images`, the script will save all images to the provided filename. In the example below, the script pulls and saves Longhorn images to the file `longhorn-images.tar.gz`. You then can copy the file to your air-gap environment. On the other hand, if you don't specify the file name, the script just pulls the list of images to your computer.
=======
This script pulls the {longhorn-product-name} chart from the SUSE Application Collection OCI registry to extract the required image list. Helm must be configured with authentication credentials to access the registry. For setup instructions, refer to the https://docs.apps.rancher.io/get-started/authentication/#helm[Helm authentication documentation].
====
+
. **Pull and Save {longhorn-product-name} Images** +
{longhorn-product-name} provides the https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/save-images.sh[`save-images.sh`] script to quickly pull images listed in the `longhorn-images.txt` file.
>>>>>>> e028cd2 (updates installation, updation, migration docs)
+
[NOTE]
====
Running this script requires Docker authentication to access the SUSE Application Collection OCI registry and pull container images. Make sure your Docker client is properly authenticated. For setup instructions, refer to the https://docs.apps.rancher.io/get-started/authentication/#docker[Docker authentication documentation].
====
+
To pull and save Longhorn images to a `tar.gz` file (for example, `longhorn-images.tar.gz`), run the following commands:
+
[,bash]
----
wget https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/save-images.sh
chmod +x save-images.sh
./save-images.sh --image-list longhorn-images.txt --images longhorn-images.tar.gz
----
<<<<<<< HEAD

* We provide another script, https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/load-images.sh[load-images.sh], to push Longhorn images to your private registry. If you specify a `tar.gz` file name for flag `--images`, the script loads images from the `tar` file and pushes them. Otherwise, it will find images in your local Docker and push them. In the example below, the script loads images from the file `longhorn-images.tar.gz` and pushes them to `<YOUR-PRIVATE-REGISTRY>`
=======
>>>>>>> e028cd2 (updates installation, updation, migration docs)
+
Then, copy the generated `longhorn-images.tar.gz` file to your air-gapped environment. If you do not specify a filename using the `--images` flag, the script will only pull the images to your local Docker image cache without saving them to a file.

. **Load and push {longhorn-product-name} images to your private registry** + 
{longhorn-product-name} provides another script, https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/load-images.sh[`load-images.sh`] script, to push images to your private container registry. To load images from a `tar.gz` file (for example, `longhorn-images.tar.gz`) and push them to your registry, run the following commands. Replace `<YOUR-PRIVATE-REGISTRY>` with the actual address of your private registry.
+
[,bash]
----
wget https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/scripts/load-images.sh
chmod +x load-images.sh
./load-images.sh --image-list longhorn-images.txt --images longhorn-images.tar.gz --registry <YOUR-PRIVATE-REGISTRY>
----
+
If you do not specify a `tar.gz` file using the `--images` flag, the script will find images in your local Docker cache and push them to the registry.

== Installing by Helm Chart

. ** Obtain {longhorn-product-name} Chart** +
Obtain the {longhorn-product-name} Chart and decompress the downloaded tarball:
+
[,bash]
----
helm pull longhorn oci://dp.apps.rancher.io/charts/suse-storage:{patch-version}
tar -zxf suse-storage-{patch-version}.tgz
cd suse-storage
----

. **Configure Image Settings in `values.yaml`** +
After cloning, configure your image settings in the `values.yaml` file based on your chosen method:
+
[cols="1,2a",options="header",width="100%"]
|===
| Method
| Configuration Details

| Using Default Image Names
|
In `values.yaml`, specify your `Private registry URL`. If the registry requires authentication, also specify `Private registry user`, `Private registry password`, and `Private registry secret`. {longhorn-product-name} will automatically generate a secret with that information and use it to pull images from your private registry.

[,yaml]
----
privateRegistry:
  # -- Setting that allows you to create a private registry secret.
  createSecret: true
  # -- URL of a private registry. When unspecified, Longhorn uses the default system registry.
  registryUrl: <REGISTRY_URL>
  # -- User account used for authenticating with a private registry.
  registryUser: <REGISTRY_USER>
  # -- Password for authenticating with a private registry.
  registryPasswd: <REGISTRY_PASSWORD>
  # -- Kubernetes secret that allows you to pull images from a private registry. This setting applies only when creation of private registry secrets is enabled. You must include the private registry name in the secret name.
  registrySecret: <REGISTRY_SECRET_NAME>
----

| Using Custom Image Names
|
In `values.yaml`, configure the image settings for each component.

[NOTE]
====
Do not include the private registry prefix (for example, `example.com/username/`); it will be added automatically. If your image is `example.com/username/longhorn-manager`, use `username/longhorn-manager` in the following charts.
====

<<<<<<< HEAD
== Using a Manifest File/v{patch-version}

. Get deployment manifest file
+
`+wget https://raw.githubusercontent.com/longhorn/longhorn/v{patch-version}/deploy/longhorn.yaml+`

. Create Longhorn namespace
+
`kubectl create namespace longhorn-system`

. If private registry require authentication, Create `docker-registry` secret in `longhorn-system` namespace:
+
`kubectl -n longhorn-system create secret docker-registry <SECRET_NAME> --docker-server=<REGISTRY_URL> --docker-username=<REGISTRY_USER> --docker-password=<REGISTRY_PASSWORD>`

 ** Add your secret name  `SECRET_NAME` to `imagePullSecrets.name` in the following resources
  *** `longhorn-driver-deployer` Deployment
  *** `longhorn-manager` DaemonSet
  *** `longhorn-ui` Deployment

+
Example:
+
[subs="+attributes",yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: longhorn-ui
  name: longhorn-ui
  namespace: longhorn-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: longhorn-ui
  template:
    metadata:
      labels:
        app: longhorn-ui
    spec:
      containers:
      - name: longhorn-ui
        image: longhornio/longhorn-ui:v0.8.0
        ports:
        - containerPort: 8000
        env:
          - name: LONGHORN_MANAGER_IP
            value: "http://longhorn-backend:9500"
      imagePullSecrets:
      - name: <SECRET_NAME>                          ## Add SECRET_NAME here
      serviceAccountName: longhorn-service-account
----

. Apply the following modifications to the manifest file
 ** Modify Kubernetes CSI driver components environment variables in `longhorn-driver-deployer` Deployment point to your private registry images
  *** CSI_ATTACHER_IMAGE
  *** CSI_PROVISIONER_IMAGE
  *** CSI_NODE_DRIVER_REGISTRAR_IMAGE
  *** CSI_RESIZER_IMAGE
  *** CSI_SNAPSHOTTER_IMAGE

+
[subs="+attributes",yaml]
----
- name: CSI_ATTACHER_IMAGE
  value: <REGISTRY_URL>/csi-attacher:<CSI_ATTACHER_IMAGE_TAG>
- name: CSI_PROVISIONER_IMAGE
  value: <REGISTRY_URL>/csi-provisioner:<CSI_PROVISIONER_IMAGE_TAG>
- name: CSI_NODE_DRIVER_REGISTRAR_IMAGE
  value: <REGISTRY_URL>/csi-node-driver-registrar:<CSI_NODE_DRIVER_REGISTRAR_IMAGE_TAG>
- name: CSI_RESIZER_IMAGE
  value: <REGISTRY_URL>/csi-resizer:<CSI_RESIZER_IMAGE_TAG>
- name: CSI_SNAPSHOTTER_IMAGE
  value: <REGISTRY_URL>/csi-snapshotter:<CSI_SNAPSHOTTER_IMAGE_TAG>
----
 ** Modify Longhorn images to point to your private registry images
  *** longhornio/longhorn-manager
+
`image: <REGISTRY_URL>/longhorn-manager:<LONGHORN_MANAGER_IMAGE_TAG>`

  *** longhornio/longhorn-engine
+
`image: <REGISTRY_URL>/longhorn-engine:<LONGHORN_ENGINE_IMAGE_TAG>`

  *** longhornio/longhorn-instance-manager
+
`image: <REGISTRY_URL>/longhorn-instance-manager:<LONGHORN_INSTANCE_MANAGER_IMAGE_TAG>`

  *** longhornio/longhorn-share-manager
+
`image: <REGISTRY_URL>/longhorn-share-manager:<LONGHORN_SHARE_MANAGER_IMAGE_TAG>`

  *** longhornio/longhorn-ui
+
`image: <REGISTRY_URL>/longhorn-ui:<LONGHORN_UI_IMAGE_TAG>`

+
Example:
+
[subs="+attributes",yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: longhorn-ui
  name: longhorn-ui
  namespace: longhorn-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: longhorn-ui
  template:
    metadata:
      labels:
        app: longhorn-ui
    spec:
      containers:
      - name: longhorn-ui
        image: <REGISTRY_URL>/longhorn-ui:<LONGHORN_UI_IMAGE_TAG>   ## Add image name and tag here
        ports:
        - containerPort: 8000
        env:
          - name: LONGHORN_MANAGER_IP
            value: "http://longhorn-backend:9500"
      imagePullSecrets:
      - name: <SECRET_NAME>
      serviceAccountName: longhorn-service-account
----
. Deploy Longhorn using modified manifest file
`kubectl apply -f longhorn.yaml`

== Using a Helm Chart

{longhorn-product-name} automatically adds +++<REGISTRY_URL>+++prefix to images. You simply need to set the registryUrl parameters to pull images from your private registry.+++</REGISTRY_URL>+++

NOTE: Once you set registryUrl to your private registry, {longhorn-product-name} tries to pull images from the registry exclusively. Make sure all component images are in the registry otherwise {longhorn-product-name} will fail to pull images.

=== Use default image name

If you keep the images' names as recommended xref:#_recommendation[here], you only need to do the following steps:

. Clone the Longhorn repo:
+
`+git clone https://github.com/longhorn/longhorn.git+`

. In `chart/values.yaml`
 ** Specify `Private registry URL`. If the registry requires authentication, specify `Private registry user`, `Private registry password`, and `Private registry secret`.
 {longhorn-product-name} will automatically generate a secret with the those information and use it to pull images from your private registry.
+
[subs="+attributes",yaml]
----
defaultSettings:
  registrySecret: <SECRET_NAME>

privateRegistry:
    registryUrl: <REGISTRY_URL>
    registryUser: <REGISTRY_USER>
    registryPasswd: <REGISTRY_PASSWORD>
    registrySecret: <REGISTRY_SECRET_NAME>
----

=== Use custom image name

If you want to use custom images' names, you can use the following steps:

. Clone longhorn repo
+
`+git clone https://github.com/longhorn/longhorn.git+`

. In `chart/values.yaml`
+
NOTE: Do not include the private registry prefix, it will be added automatically. e.g: if your image is `example.com/username/longhorn-manager`, use `username/longhorn-manager` in the following charts.

 ** Specify images and tag:
+
[subs="+attributes",yaml]
=======
Specify the `repository` and `tag` for each {longhorn-product-name} component image:

[,yaml]
>>>>>>> e028cd2 (updates installation, updation, migration docs)
----
  image:
    longhorn:
      engine:
        repository: <USERNAME>/longhorn-engine
        tag: <LONGHORN_ENGINE_IMAGE_TAG>
      manager:
        repository: <USERNAME>/longhorn-manager
        tag: <LONGHORN_MANAGER_IMAGE_TAG>
      ui:
        repository: <USERNAME>/longhorn-ui
        tag: <LONGHORN_UI_IMAGE_TAG>
      instanceManager:
        repository: <USERNAME>/longhorn-instance-manager
        tag: <LONGHORN_INSTANCE_MANAGER_IMAGE_TAG>
      shareManager:
        repository: <USERNAME>/longhorn-share-manager
        tag: <LONGHORN_SHARE_MANAGER_IMAGE_TAG>
----
Specify the `repository` and `tag` for CSI Driver components images:

[,yaml]
----
    csi:
      attacher:
        repository: <USERNAME>/csi-attacher
        tag: <CSI_ATTACHER_IMAGE_TAG>
      provisioner:
        repository: <USERNAME>/csi-provisioner
        tag: <CSI_PROVISIONER_IMAGE_TAG>
      nodeDriverRegistrar:
        repository: <USERNAME>/csi-node-driver-registrar
        tag: <CSI_NODE_DRIVER_REGISTRAR_IMAGE_TAG>
      resizer:
        repository: <USERNAME>/csi-resizer
        tag: <CSI_RESIZER_IMAGE_TAG>
      snapshotter:
        repository: <USERNAME>/csi-snapshotter
        tag: <CSI_SNAPSHOTTER_IMAGE_TAG>
----
Finally, specify your `Private registry URL`. If the registry requires authentication, specify `Private registry user`, `Private registry password`, and `Private registry secret`. {longhorn-product-name} will automatically generate a secret with that information and use it to pull images from your private registry.

<<<<<<< HEAD
 ** Specify `Private registry URL`. If the registry requires authentication, specify `Private registry user`, `Private registry password`, and `Private registry secret`.
 {longhorn-product-name} will automatically generate a secret with the those information and use it to pull images from your private registry.
+
=======
>>>>>>> e028cd2 (updates installation, updation, migration docs)
[,yaml]
----
privateRegistry:
  # -- Setting that allows you to create a private registry secret.
  createSecret: true
  # -- URL of a private registry. When unspecified, Longhorn uses the default system registry.
  registryUrl: <REGISTRY_URL>
  # -- User account used for authenticating with a private registry.
  registryUser: <REGISTRY_USER>
  # -- Password for authenticating with a private registry.
  registryPasswd: <REGISTRY_PASSWORD>
  # -- Kubernetes secret that allows you to pull images from a private registry. This setting applies only when creation of private registry secrets is enabled. You must include the private registry name in the secret name.
  registrySecret: <REGISTRY_SECRET_NAME>
----
|===

. **Install {longhorn-product-name}** +
Install {longhorn-product-name} by running the following command in the cloned directory:
+
[,bash]
----
helm install longhorn --namespace longhorn-system --create-namespace ./
----
<<<<<<< HEAD

= Using a Rancher App

[discrete]
=== Use default image name

If you keep the images' names as recommended <<Recommendation, here>>, you only need to do the following steps:

* In the `Private Registry Settings` section specify:
 ** Private registry URL
 ** Private registry user
 ** Private registry password
 ** Private registry secret name

+
{longhorn-product-name} will automatically generate a secret with the those information and use it to pull images from your private registry.
+
image::screenshots/airgap-deploy/app-default-images.png[images]

[discrete]
=== Use custom image name

* If you want to use custom images' names, you can set `Use Default Images` to `False` and specify images' names.
+
NOTE: Do not include the private registry prefix, it will be added automatically. e.g: if your image is `example.com/username/longhorn-manager`, use `username/longhorn-manager` in the following charts.
+
image::screenshots/airgap-deploy/app-custom-images.png[images]

* Specify `Private registry URL`. If the registry requires authentication, specify `Private registry user`, `Private registry password`, and `Private registry secret name`.
{longhorn-product-name} will automatically generate a secret with the those information and use it to pull images from your private registry.
+
image::screenshots/airgap-deploy/app-custom-images-reg.png[images]

== Troubleshooting

[discrete]
==== For Helm/Rancher installation, if user forgot to submit a secret to authenticate to private registry, `longhorn-manager DaemonSet` will fail to create.

. Create the Kubernetes secret
+
`kubectl -n longhorn-system create secret docker-registry <SECRET_NAME> --docker-server=<REGISTRY_URL> --docker-username=<REGISTRY_USER> --docker-password=<REGISTRY_PASSWORD>`

. Create `registry-secret` setting object manually.
+
[subs="+attributes",yaml]
----
 apiVersion: longhorn.io/v1beta2
 kind: Setting
 metadata:
   name: registry-secret
   namespace: longhorn-system
 value: <SECRET_NAME>
----
+
`kubectl apply -f registry-secret.yml`

. Delete {longhorn-product-name} and re-install it again.
 ** *Helm2*
+
`helm uninstall ./chart --name longhorn --namespace longhorn-system`
+
`helm install ./chart --name longhorn --namespace longhorn-system`

 ** *Helm3*
+
`helm uninstall longhorn ./chart --namespace longhorn-system`
+
`helm install longhorn ./chart --namespace longhorn-system`

== Recommendation

It's highly recommended not to manipulate image tags, especially instance manager image tags such as v1_20200301, because we intentionally use the date to avoid associating it with a {longhorn-product-name} version.

The component images are hosted in Dockerhub under the `longhornio` account. For example, `longhornio/longhorn-manager:v{patch-version}` (you can replace v{patch-version} with your desired {longhorn-product-name} version). It is recommended to keep the account name, `longhornio`, the same when you push the images to your private registry. This helps avoid unnecessary configuration issues.
=======
>>>>>>> e028cd2 (updates installation, updation, migration docs)
